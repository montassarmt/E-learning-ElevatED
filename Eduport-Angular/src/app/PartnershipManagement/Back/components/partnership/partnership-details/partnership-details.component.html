<div class="card" *ngIf="partnership">
  <div class="card-header">
    <h2>Partnership Details</h2>
  </div>

  <div class="card-body">
    <p><strong>Status:</strong> {{ partnership.partnershipStatus }}</p>
    <p *ngIf="partnership.entreprise">
      <strong>Entreprise:</strong> {{ partnership.entreprise.nameEntreprise }}
    </p>

    <div *ngIf="partnership.proposals" class="section">
      <p><strong>Proposal Start Date:</strong> {{ partnership.proposals.startDate | date }}</p>
      <p><strong>Proposal End Date:</strong> {{ partnership.proposals.endDate | date }}</p>
      <p><strong>Amount Agreed:</strong> {{ partnership.proposals.plannedAmount }} TND</p>
    </div>

    <!-- Assessments Section -->
    <div *ngIf="partnership.partnershipStatus === 'Approved'" class="mt-4">
      <h3>Agreements (Assessments)</h3>

      <p *ngIf="assessments.length === 0" class="text-muted">No agreements added yet.</p>

      <div *ngFor="let a of assessments" class="card mb-3 p-3 shadow-sm border">
        <p><strong> Subject </strong>
            {{ a.feedback }}
        </p>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <p class="mb-0">
            <strong>Status:</strong> {{ a.status }}
          </p>
          <label class="cyberpunk-checkbox-label">
            <input 
                  type="checkbox" 
                  class="cyberpunk-checkbox" 
                  [checked]="a.status === 'Done'" 
                  [disabled]="a.status === 'Done' || a.status === 'Undone'"
                  (change)="markAsCompleted(a.idAssessment)" />
            Completed
          </label>
        </div>
        
        <!-- Acceptance Status with Dynamic Styling -->
        <p><strong>Acceptance status : </strong>
          <span [ngClass]="getAcceptanceStatusClass(a.acceptanceStatus)">
            {{ a.acceptanceStatus }}
          </span>
        </p>

        <div class="d-flex gap-3 flex-wrap align-items-center">
          <!-- Admin Actions -->
          <div class="d-flex gap-2">
            <button 
              class="btn btn-outline-success btn-sm" 
              (click)="onAdminDecision(a.idAssessment, 'Accept')" 
              [disabled]="a.acceptanceStatus !== 'Pending'">
              Accept Agreement (Admin)
            </button>
            <button 
              class="btn btn-outline-danger btn-sm" 
              (click)="onAdminDecision(a.idAssessment, 'Reject')" 
              [disabled]="a.acceptanceStatus !== 'Pending'">
              Reject Agreement (Admin)
            </button>
          </div>

          <!-- Partner Actions -->
          <div class="d-flex gap-2">
            <button 
              class="btn btn-outline-success btn-sm" 
              (click)="onPartnerDecision(a.idAssessment, 'Accept')" 
              [disabled]="a.acceptanceStatus !== 'Pending'">
              Accept Agreement (Partner)
            </button>
            <button 
              class="btn btn-outline-danger btn-sm" 
              (click)="onPartnerDecision(a.idAssessment, 'Reject')" 
              [disabled]="a.acceptanceStatus !== 'Pending'">
              Reject Agreement (Partner)
            </button>
          </div>
        </div>
      </div>

      <!-- Add agreement toggle -->
      <button class="btn btn-outline-primary" (click)="showAdd = !showAdd">
        {{ showAdd ? 'Cancel' : 'Add Agreement' }}
      </button>

      <!-- New agreement form -->
      <div *ngIf="showAdd" class="mt-3">
        <textarea [(ngModel)]="newFeedback" class="form-control" rows="3" placeholder="Enter your agreement/feedback..."></textarea>
        <button class="btn btn-success mt-2" (click)="saveAgreement()">Save</button>
      </div>
    </div>

    <!-- Download button -->
    <div class="mt-4">
      <button class="btn btn-primary" (click)="downloadPDF()">Download PDF</button>
    </div>
  </div>
</div>

<!-- Fallback for missing partnership -->
<div *ngIf="!partnership" class="text-center text-muted mt-5">
  <p>Loading partnership details...</p>
</div>
